{% extends "base.html" %}

{% block title %}{{ t('audit.title') }} - {{ t('app.name') }}{% endblock %}

{% block content %}
<h1 class="page-title">{{ t('audit.title') }}</h1>

<div class="section">
    <form method="get" style="display: flex; gap: 15px; flex-wrap: wrap; align-items: flex-end;">
        <div class="form-group" style="margin-bottom: 0;">
            <label>{{ t('audit.event') }}</label>
            <select name="event" onchange="this.form.submit()">
                <option value="">{{ t('audit.all_events') }}</option>
                <option value="login" {% if request.args.get('event') == 'login' %}selected{% endif %}>ğŸ”“ Login</option>
                <option value="logout" {% if request.args.get('event') == 'logout' %}selected{% endif %}>ğŸ”’ Logout</option>
                <option value="login_failed" {% if request.args.get('event') == 'login_failed' %}selected{% endif %}>â›” Login Failed</option>
                <option value="config_change" {% if request.args.get('event') == 'config_change' %}selected{% endif %}>âš™ï¸ Config Change</option>
                <option value="user_change" {% if request.args.get('event') == 'user_change' %}selected{% endif %}>ğŸ‘¤ User Change</option>
                <option value="relay_control" {% if request.args.get('event') == 'relay_control' %}selected{% endif %}>âš¡ Relay Control</option>
                <option value="scheduled_restart" {% if request.args.get('event') == 'scheduled_restart' %}selected{% endif %}>ğŸ“… Scheduled Restart</option>
                <option value="auto_restart" {% if request.args.get('event') == 'auto_restart' %}selected{% endif %}>ğŸ”„ Auto Restart</option>
                <option value="password_change" {% if request.args.get('event') == 'password_change' %}selected{% endif %}>ğŸ”‘ Password Change</option>
            </select>
        </div>
        
        <div class="form-group" style="margin-bottom: 0;">
            <label>{{ t('audit.user') }}</label>
            <input type="text" name="user" value="{{ request.args.get('user', '') }}" placeholder="username" style="width: 150px;">
        </div>
        
        <button type="submit" class="btn btn-primary">{{ t('audit.filter') }}</button>
        <a href="/audit" class="btn btn-secondary">Reset</a>
        
        {% if has_permission('manage_system') %}
        <div style="margin-left: auto;">
            <button type="button" class="btn btn-power-off" onclick="document.getElementById('delete-audit-modal').style.display='flex'">
                ğŸ—‘ï¸ {{ 'Smazat audit' if language == 'cs' else 'Delete Audit' }}
            </button>
        </div>
        {% endif %}
    </form>
</div>

<div class="section">
    {% if entries %}
    <table>
        <thead>
            <tr>
                <th style="width: 160px;">{{ t('audit.time') }}</th>
                <th style="width: 180px;">{{ t('audit.event') }}</th>
                <th>{{ t('audit.user') }}</th>
                <th>{{ t('audit.ip') }}</th>
                <th>{{ t('audit.target') }}</th>
                <th>{{ t('audit.details') }}</th>
            </tr>
        </thead>
        <tbody>
            {% for entry in entries %}
            <tr>
                <td style="font-size: 0.9em; color: var(--text-secondary);">{{ entry.formatted_time }}</td>
                <td>
                    <span style="font-size: 1.2em;">{{ entry.icon }}</span>
                    {{ entry.event_name }}
                </td>
                <td><strong>{{ entry.user }}</strong></td>
                <td style="font-family: monospace; font-size: 0.9em;">{{ entry.ip or '-' }}</td>
                <td>{{ entry.target or '-' }}</td>
                <td style="font-size: 0.9em; color: var(--text-secondary);">{{ entry.details or '-' }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p style="text-align: center; color: var(--text-secondary); padding: 40px;">
        {{ 'Å½Ã¡dnÃ© zÃ¡znamy' if language == 'cs' else 'No entries' }}
    </p>
    {% endif %}
</div>

<!-- Delete Audit Modal -->
{% if has_permission('manage_system') %}
<div id="delete-audit-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: var(--card-bg); padding: 30px; border-radius: 10px; max-width: 450px; width: 90%;">
        <h3 style="margin-top: 0;">ğŸ—‘ï¸ {{ 'Smazat audit log' if language == 'cs' else 'Delete Audit Log' }}</h3>
        <p style="color: var(--warning-color); margin-bottom: 15px;">
            âš ï¸ {{ 'Tato akce je nevratnÃ¡! Audit log obsahuje dÅ¯leÅ¾itÃ© bezpeÄnostnÃ­ zÃ¡znamy.' if language == 'cs' else 'This action is irreversible! Audit log contains important security records.' }}
        </p>
        <form method="post" action="/audit/delete">
            <input type="hidden" name="_csrf_token" value="{{ csrf_token() }}">
            
            <div class="form-group">
                <label>{{ 'Smazat zÃ¡znamy starÅ¡Ã­ neÅ¾' if language == 'cs' else 'Delete records older than' }}:</label>
                <select name="older_than" style="width: 100%; padding: 10px; margin-top: 5px;">
                    <option value="0">{{ 'VÅ¡e' if language == 'cs' else 'Everything' }}</option>
                    <option value="7">7 {{ 'dnÃ­' if language == 'cs' else 'days' }}</option>
                    <option value="30" selected>30 {{ 'dnÃ­' if language == 'cs' else 'days' }}</option>
                    <option value="90">90 {{ 'dnÃ­' if language == 'cs' else 'days' }}</option>
                    <option value="180">180 {{ 'dnÃ­' if language == 'cs' else 'days' }}</option>
                    <option value="365">365 {{ 'dnÃ­' if language == 'cs' else 'days' }}</option>
                </select>
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button type="submit" class="btn btn-power-off" onclick="return confirm('{{ 'Opravdu smazat audit log?' if language == 'cs' else 'Really delete audit log?' }}')">
                    ğŸ—‘ï¸ {{ 'Smazat' if language == 'cs' else 'Delete' }}
                </button>
                <button type="button" class="btn btn-secondary" onclick="document.getElementById('delete-audit-modal').style.display='none'">
                    {{ 'ZruÅ¡it' if language == 'cs' else 'Cancel' }}
                </button>
            </div>
        </form>
    </div>
</div>
{% endif %}
{% endblock %}
