{% extends "base.html" %}

{% block title %}{{ t('nav.outlets') if t('nav.outlets') != 'nav.outlets' else 'Správa zásuvek' }} - {{ t('app.name') }}{% endblock %}

{% block content %}
<h1 class="page-title">{{ 'Správa zásuvek (GPIO)' if language == 'cs' else 'Outlet Management (GPIO)' }}</h1>

<div class="section">
    <h3>{{ 'Přidat zásuvku' if language == 'cs' else 'Add Outlet' }}</h3>
    <form method="post" action="/outlets/add">
        <input type="hidden" name="_csrf_token" value="{{ csrf_token() }}">
        <div class="form-row">
            <div class="form-group">
                <label>{{ 'Název zásuvky' if language == 'cs' else 'Outlet Name' }}</label>
                <input type="text" name="outlet_name" required placeholder="{{ 'Zásuvka 9' if language == 'cs' else 'Outlet 9' }}">
            </div>
            <div class="form-group">
                <label>GPIO Pin (BCM)</label>
                <select name="gpio_pin" required>
                    <option value="">-- {{ 'Vyberte pin' if language == 'cs' else 'Select pin' }} --</option>
                    {% for pin, info in gpio_info.items() | sort %}
                        {% if pin not in used_pins %}
                        <option value="{{ pin }}" {% if not info.safe %}style="color: var(--button-restart);"{% endif %}>
                            GPIO {{ pin }} - {{ info.name }}
                            {% if not info.safe %}({{ info.alt }}){% endif %}
                        </option>
                        {% endif %}
                    {% endfor %}
                </select>
                <p class="help">{{ 'Žluté položky mají alternativní funkce (I2C, SPI, UART)' if language == 'cs' else 'Yellow items have alternate functions (I2C, SPI, UART)' }}</p>
            </div>
        </div>
        <button type="submit" class="btn btn-primary">{{ t('common.add') }}</button>
    </form>
</div>

<div class="section">
    <h3>{{ 'Nakonfigurované zásuvky' if language == 'cs' else 'Configured Outlets' }} ({{ outlets | length }})</h3>
    
    <table>
        <thead>
            <tr>
                <th>ID</th>
                <th>{{ 'Název' if language == 'cs' else 'Name' }}</th>
                <th>GPIO Pin</th>
                <th>{{ 'Info' if language == 'cs' else 'Info' }}</th>
                <th>{{ 'Použito' if language == 'cs' else 'Used by' }}</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            {% for key, outlet in outlets.items() %}
            <tr>
                <td><code>{{ key }}</code></td>
                <td>
                    <form method="post" action="/outlets/rename/{{ key }}" style="display: inline;">
                        <input type="hidden" name="_csrf_token" value="{{ csrf_token() }}">
                        <input type="text" name="new_name" value="{{ outlet.name }}" 
                               style="width: 150px; padding: 5px;" 
                               onchange="this.form.submit()">
                    </form>
                </td>
                <td>
                    <strong>GPIO {{ outlet.gpio_pin }}</strong>
                    {% set pin_info = gpio_info.get(outlet.gpio_pin, {}) %}
                    {% if not pin_info.get('safe', True) %}
                    <span style="color: var(--button-restart);" title="{{ pin_info.alt }}">⚠️</span>
                    {% endif %}
                </td>
                <td style="color: var(--text-secondary); font-size: 0.85em;">
                    {{ gpio_info.get(outlet.gpio_pin, {}).get('name', '-') }}
                </td>
                <td>
                    {% set used_by = [] %}
                    {% for group in groups %}
                        {% if group.outlet == key %}
                            {% set _ = used_by.append(group.name) %}
                        {% endif %}
                    {% endfor %}
                    {% if used_by %}
                        <span style="color: var(--accent-color);">{{ used_by | join(', ') }}</span>
                    {% else %}
                        <span style="color: var(--text-secondary);">-</span>
                    {% endif %}
                </td>
                <td>
                    {% if key not in used_outlets %}
                    <form method="post" action="/outlets/delete/{{ key }}" style="display: inline;">
                        <input type="hidden" name="_csrf_token" value="{{ csrf_token() }}">
                        <button type="submit" class="btn btn-power-off" style="padding: 5px 10px;"
                                onclick="return confirm('{{ 'Smazat zásuvku?' if language == 'cs' else 'Delete outlet?' }}')">
                            {{ t('common.delete') }}
                        </button>
                    </form>
                    {% else %}
                    <span style="color: var(--text-secondary); font-size: 0.85em;">
                        {{ 'Používáno' if language == 'cs' else 'In use' }}
                    </span>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div class="section">
    <h3>{{ 'GPIO Pinout Reference' if language == 'en' else 'GPIO Pinout Reference' }}</h3>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
        <div>
            <h4 style="color: var(--button-on); margin-bottom: 10px;">✓ {{ 'Doporučené piny' if language == 'cs' else 'Recommended Pins' }}</h4>
            <p style="font-size: 0.9em; color: var(--text-secondary);">
                GPIO 4, 5, 6, 12, 13, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27
            </p>
            <p class="help">{{ 'Bezpečné obecné GPIO bez speciálních funkcí' if language == 'cs' else 'Safe general GPIO without special functions' }}</p>
        </div>
        <div>
            <h4 style="color: var(--button-restart); margin-bottom: 10px;">⚠️ {{ 'Alternativní funkce' if language == 'cs' else 'Alternate Functions' }}</h4>
            <p style="font-size: 0.9em; color: var(--text-secondary);">
                GPIO 2, 3 (I2C) | GPIO 7-11 (SPI) | GPIO 14, 15 (UART)
            </p>
            <p class="help">{{ 'Lze použít, pokud nepotřebujete I2C/SPI/UART' if language == 'cs' else 'Can use if you don\'t need I2C/SPI/UART' }}</p>
        </div>
    </div>
    
    <div style="margin-top: 20px; padding: 15px; background: var(--bg-primary); border-radius: 5px;">
        <h4 style="margin-bottom: 10px;">{{ 'Fyzické zapojení' if language == 'cs' else 'Physical Wiring' }}</h4>
        <pre style="font-size: 0.85em; line-height: 1.6; margin: 0;">
┌─────────────────────────────────────┐
│  Raspberry Pi GPIO Header (J8)      │
├─────────────────────────────────────┤
│  3V3 (1)  (2)  5V                   │
│  SDA (3)  (4)  5V    ← GPIO 2       │
│  SCL (5)  (6)  GND   ← GPIO 3       │
│  GP4 (7)  (8)  TXD   ← GPIO 14      │
│  GND (9)  (10) RXD   ← GPIO 15      │
│ GP17 (11) (12) GP18  ← Recommended  │
│ GP27 (13) (14) GND                  │
│ GP22 (15) (16) GP23  ← Recommended  │
│  3V3 (17) (18) GP24  ← Recommended  │
│ MOSI (19) (20) GND   ← GPIO 10      │
│ MISO (21) (22) GP25  ← Recommended  │
│ SCLK (23) (24) CE0   ← GPIO 8       │
│  GND (25) (26) CE1   ← GPIO 7       │
│  ID  (27) (28) ID                   │
│  GP5 (29) (30) GND   ← Recommended  │
│  GP6 (31) (32) GP12  ← Recommended  │
│ GP13 (33) (34) GND   ← Recommended  │
│ GP19 (35) (36) GP16  ← Recommended  │
│ GP26 (37) (38) GP20  ← Recommended  │
│  GND (39) (40) GP21  ← Recommended  │
└─────────────────────────────────────┘
        </pre>
    </div>
</div>
{% endblock %}
